<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Wallet</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="module" src="https://github.com/xloem/bitcoinjs-lib-browser/blob/master/bitcoinjs.min.js"></script>
    <script>
        $(function () {
            $.ajax({
                url: '/wallet',
                type: 'POST',
                success: function (resp) {
                    $('#public_key').val(resp['public_key'])
                    $('#private_key').val(resp['private_key'])
                    $('#blockchain_address').val(resp['blockchain_address'])
                    console.info(resp)
                },
                error: function (err) {
                    console.error(err)
                }
            })

            $('#send_money_button').click(async function () {
                let confirm_text = 'Are you sure to send?'
                let confirm_result = confirm(confirm_text)
                if (confirm_result !== true) {
                    alert('Canceled!')
                    return
                }
                let transaction_data = {
                    //'sender_private_key': $('#private_key').val(),
                    'sender_public_key': $('#public_key').val(),
                    'sender_address': $('#blockchain_address').val(),
                    'recipient_address': $('#recipient_blockchain_address').val(),
                    'value': +$('#send_amount').val(),
                }

                var address = new Bitcoin.Address(Crypto.util.hexToBytes(hash160))
                address.version = 0x00 //testnet would be 0x6F
                address = address.toString()

                const enc = new TextEncoder();
                const jtd = JSON.stringify(transaction_data)
                const encodedMessage = enc.encode(jtd);
                const keyPair = window.crypto.subtle.generateKey(
                    {
                        name: "ECDSA",
                        namedCurve: "P-384"
                    },
                    true,
                    ["sign", "verify"]
                );
                const {
                    privateKey,
                    publicKey
                } = await keyPair;
                // const byteArray = new TextEncoder().encode($('#public_key').val());
                // const buffer = byteArray.buffer;
                // const privateKey = window.crypto.subtle.unwrapKey(
                //     "raw",
                //     buffer,
                //     {
                //         name: "ECDSA",
                //         namedCurve: "P-384",
                //     },
                //     true,
                //     ["encrypt", "decrypt"]
                // );

                let sig = await (async () => {
                    const signature = await window.crypto.subtle.sign(
                        {
                            name: "ECDSA",
                            hash: { name: "SHA-384" },
                        },
                        privateKey,
                        encodedMessage
                    );
                    // const signatureValid = await window.crypto.subtle.verify("RSASSA-PKCS1-v1_5", publicKey, signature, encodedMessage);
                    return signature
                })()

                let signature = btoa(sig);
                transaction_data.signature = signature

                console.info(transaction_data)

                $.ajax({
                    url: '/transaction',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(transaction_data),
                    success: function (resp) {
                        alert("Success!!")
                        console.info(resp)
                    },
                    error: function (err) {
                        alert("Fail!!!")
                        console.error(err)
                    }
                })


            }


            )

        })
    </script>
    <script>
        async function Sign(transaction_data) {
            const enc = new TextEncoder();
            const encodedMessage = enc.encode(transaction_data);
            const keyPair = window.crypto.subtle.generateKey({
                name: "RSASSA-PKCS1-v1_5",
                modulusLength: 4096,
                publicExponent: new Uint8Array([1, 0, 1]),
                hash: "SHA-256"
            },
                true,
                ["sign", "verify"]
            );
            (async () => {
                const {
                    privateKey,
                    publicKey
                } = await keyPair;
                const signature = await window.crypto.subtle.sign(
                    "RSASSA-PKCS1-v1_5",
                    privateKey,
                    encodedMessage
                );
                // const signatureValid = await window.crypto.subtle.verify("RSASSA-PKCS1-v1_5", publicKey, signature, encodedMessage);
                console.log("SSS" + signature);
                return signature
            })()
        }
    </script>
</head>


<body>
    <div>
        <h1>Wallet</h1>
        <div id="wallet_amount">0</div>
        <button id="reload_wallet">Reload Wallet</button>

        <p>Public Key</p>
        <textarea id="public_key" rows="2" cols="100"></textarea>

        <p>Private Key</p>
        <textarea id="private_key" rows="1" cols="100"></textarea>

        <p>Blockchain Address</p>
        <textarea id="blockchain_address" rows="1" cols="100"></textarea>

    </div>

    <div>
        <h1>Send Money</h1>
        <div>
            Address: <input id="recipient_blockchain_address" size="100" type="text">
            <br>
            Amount: <input id="send_amount" type="text">
            <br>
            <button id="send_money_button">Send</button>
        </div>
    </div>

</body>

</html>